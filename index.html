<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fixkosten Tool – Bubbles</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#666;
      --card:#f6f6f7;
      --border:#e6e6ea;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:var(--bg);
    }

    header{
      padding:18px 20px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      background:#fff;
      z-index:10;
    }
    .titleblock h1{ margin:0; font-size:22px; letter-spacing:.5px; }
    .titleblock .sub{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .top-right{ display:flex; gap:10px; align-items:flex-start; justify-content:flex-end; flex-wrap:wrap; }

    .nav{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .tab.active{ background:#111; color:#fff; border-color:#111; }

    /* segmented control */
    .seg{
      display:inline-flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
    }
    .seg button{
      border:0;
      border-right:1px solid var(--border);
      border-radius:0;
      box-shadow:none;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      background:#fff;
    }
    .seg button:last-child{ border-right:0; }
    .seg button.active{ background:#111; color:#fff; }

    button{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
      font-weight:700;
    }
    button:hover{ border-color:#d3d3db; }
    button.primary{ background:#111; color:#fff; border-color:#111; }
    button.danger{ background:#fff; color:#b00020; border-color:#f0c0c8; }

    .wrap{ padding:14px 20px 30px; display:grid; grid-template-columns: 1fr; gap:14px; }
    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }

    .stats{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .stat{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      min-width:220px;
    }
    .stat .label{ color:var(--muted); font-size:12px; }
    .stat .value{ font-size:20px; margin-top:4px; font-weight:950; }

    .stage{
      position:relative;
      width:100%;
      height: 72vh;
      min-height:520px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background:#fff;
      overflow:hidden;
    }
    .bubble{
      position:absolute;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      user-select:none;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
      transition: transform .12s ease, box-shadow .12s ease;
      color:#111;
      text-align:center;
      padding:10px;
    }
    .bubble:hover{ transform: scale(1.03); box-shadow: 0 14px 34px rgba(0,0,0,.14); }
    .bubble .name{ font-weight:950; line-height:1.1; margin-bottom:6px; word-break:break-word; }
    .bubble .amount{ font-weight:950; letter-spacing:.2px; }
    .bubble .meta{ margin-top:6px; font-size:12px; color:rgba(0,0,0,.65); }

    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input[type="text"], input[type="number"], input[type="month"], select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      background:#fff;
    }
    textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      background:#fff;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.35;
    }

    input[type="color"]{
      width: 60px;
      height: 40px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:0;
      background:#fff;
      cursor:pointer;
    }

    .row{ display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; }
    .row > * { flex: 1; min-width: 160px; }
    .row .shrink{ flex:0 0 auto; min-width:auto; }

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
      color:#333;
      font-weight:900;
    }
    .divider{ height:1px; background:var(--border); margin:14px 0; }
    .tiny{ font-size:12px; color:var(--muted); }

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
    }
    th, td{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-size:13px;
    }
    th{ background:#fafafa; color:#333; font-size:12px; }
    tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(1020px, 100%);
      max-height: 92vh;
      overflow:auto;
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal header{
      padding:0;
      margin-bottom:10px;
      align-items:center;
      position:static;
      border:0;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .modal h2{ margin:0; font-size:18px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 760px){
      .grid2{ grid-template-columns: 1fr; }
      .stat{ min-width: 100%; }
      .stage{ height: 76vh; }
    }
    .inlineGrid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 820px){
      .inlineGrid3{ grid-template-columns: 1fr; }
    }
    .hintBox{
      margin-top:10px;
      padding:10px 12px;
      border:1px dashed var(--border);
      border-radius:12px;
      background:#fff;
      color:#333;
      font-size:12px;
    }
  </style>
</head>
<body>
  <header>
    <div class="titleblock">
      <h1 id="pageTitle">FIXKOSTEN ÜBERSICHT</h1>
      <div class="sub" id="pageSubtitle">Bubbles = Themenbereiche. Klick öffnet Details. Alles wird lokal gespeichert.</div>
    </div>

    <div class="top-right">
      <div class="nav" role="navigation" aria-label="Ansichten">
        <button class="tab active" data-route="gesamt">Gesamt</button>
        <button class="tab" data-route="pro_person">Pro Person</button>
        <button class="tab" data-route="lebenserhaltung">Lebenserhaltung</button>
        <button class="tab" data-route="privat_linda">Privat (Linda)</button>
      </div>
      <div class="pill" id="topRightPill">–</div>
    </div>
  </header>

  <main class="wrap" id="app"></main>

  <!-- Shared Modal -->
  <div class="modal-backdrop" id="backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header>
        <div>
          <h2 id="modalTitle">Thema</h2>
          <div class="tiny" id="modalSub">–</div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button id="btnDeleteTheme" class="danger">Thema löschen</button>
          <button id="btnClose">Schließen</button>
        </div>
      </header>

      <div class="grid2">
        <section class="panel">
          <h3 style="margin:0 0 10px;">Thema bearbeiten</h3>
          <div class="row">
            <div>
              <label for="themeName">Name</label>
              <input id="themeName" type="text" placeholder="z.B. Abonnements" />
            </div>
            <div class="shrink">
              <label for="themeColor">Farbe</label>
              <input id="themeColor" type="color" />
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button id="btnSaveTheme" class="primary">Speichern</button>
          </div>
          <div class="tiny" style="margin-top:8px;">Summe wird automatisch aus den Posten berechnet.</div>
        </section>

        <section class="panel">
          <h3 style="margin:0 0 10px;">Posten hinzufügen</h3>

          <div class="inlineGrid3">
            <div>
              <label for="itemName">Posten</label>
              <input id="itemName" type="text" placeholder="z.B. Netflix" />
            </div>
            <div>
              <label for="itemAmount">Betrag (Monat €)</label>
              <input id="itemAmount" type="number" step="0.01" placeholder="z.B. 12.99" />
            </div>
            <div>
              <label for="itemPayer">Zahlt</label>
              <select id="itemPayer">
                <option value="moritz">Moritz</option>
                <option value="linda">Linda</option>
                <option value="split_custom" selected>Geteilt (individuell)</option>
              </select>
            </div>

            <div>
              <label for="itemMoritz">Moritz Anteil (€)</label>
              <input id="itemMoritz" type="number" step="0.01" placeholder="z.B. 4.00" />
            </div>
            <div>
              <label for="itemLinda">Linda Anteil (€)</label>
              <input id="itemLinda" type="number" step="0.01" placeholder="z.B. 8.99" />
            </div>
            <div class="shrink">
              <label>&nbsp;</label>
              <button id="btnAddItem" class="primary">+ Hinzufügen</button>
            </div>
          </div>

          <div class="hintBox" id="addItemHint">
            Tipp: Wenn „Geteilt (individuell)“, sollten Moritz+Linda = Gesamtbetrag sein.
          </div>
        </section>
      </div>

      <div class="divider"></div>

      <section class="panel">
        <h3 style="margin:0 0 10px;">Details & Summen</h3>
        <div class="row" style="margin-bottom:10px;">
          <div class="pill" id="themeTotalPill">Summe: –</div>
          <div class="pill" id="themeItemsPill">Posten: –</div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Posten</th>
              <th class="right">Monat €</th>
              <th>Zahlt</th>
              <th class="right">Moritz €</th>
              <th class="right">Linda €</th>
              <th class="right">Aktion</th>
            </tr>
          </thead>
          <tbody id="itemsTbody">
            <tr><td colspan="6" class="muted">Keine Daten</td></tr>
          </tbody>
        </table>

        <p class="tiny" style="margin:10px 2px 0;">
          Bei „Geteilt (individuell)“ kannst du Moritz/Linda direkt ändern.
        </p>
      </section>
    </div>
  </div>

  <script>
    /**********************
     * Fixes in dieser Version:
     * 1) uid() ist VOR Private-Seed definiert (sonst ReferenceError)
     * 2) renderPrivateLindaView() ist Top-Level (nicht in renderLivingView)
     * 3) renderBubblesView benutzt korrekt root.appendChild(...) (damit mountEl funktioniert)
     **********************/

    const LS_MAIN = "finance_bubbles_v2";
    const LS_LIVING = "finance_living_v1";
    const LIVING_START = 650;

    const LS_PRIVATE_LINDA = "finance_private_linda_v1";

    /** Utils **/
    function uid(){
      if (crypto?.randomUUID) return crypto.randomUUID();
      return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    }
    function euro(n){
      const v = Number(n || 0);
      return v.toLocaleString("de-DE", { style:"currency", currency:"EUR" });
    }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function normalizePayer(p){
      const v = String(p || "split_custom");
      if(v === "moritz" || v === "linda" || v === "split_custom") return v;
      return "split_custom";
    }

    /** Private Linda **/
    const SEED_PRIVATE_LINDA = {
      blocks: [
        { id: uid(), title: "Meine Übersicht", content: "Alles hier ist privat & frei editierbar.\n\n• Notizen\n• Ideen\n• Erinnerungen" }
      ]
    };

    function savePrivateLinda(){
      localStorage.setItem(LS_PRIVATE_LINDA, JSON.stringify(privateLindaState));
    }
    function loadPrivateLinda(){
      try{
        const raw = localStorage.getItem(LS_PRIVATE_LINDA);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        if(!parsed || typeof parsed !== "object") return null;
        parsed.blocks = Array.isArray(parsed.blocks) ? parsed.blocks.map(b => ({
          id: String(b.id || uid()),
          title: String(b.title || "Ohne Titel"),
          content: String(b.content || "")
        })) : [];
        return parsed;
      }catch{ return null; }
    }

    let privateLindaState = loadPrivateLinda() ?? structuredClone(SEED_PRIVATE_LINDA);

    /** People **/
    const PEOPLE = [
      { id:"moritz", name:"Moritz" },
      { id:"linda", name:"Linda" }
    ];

    /** Themes **/
    function mkTheme(name, color, items = []){
      return {
        id: uid(),
        name,
        color,
        items: items.map(it => normalizeItem({
          id: uid(),
          name: it.name,
          amount: Number(it.amount || 0),
          payer: it.payer,
          moritz_share: it.moritz_share,
          linda_share: it.linda_share
        }))
      };
    }

    function normalizeItem(it){
      const payer = normalizePayer(it.payer);
      const amount = Number(it.amount || 0);

      let m = Number(it.moritz_share ?? 0);
      let l = Number(it.linda_share ?? 0);

      if(payer === "moritz" || payer === "linda"){
        m = 0; l = 0;
      } else {
        const haveShares = isFinite(m) && isFinite(l) && (m !== 0 || l !== 0);
        if(!haveShares){
          m = amount / 2;
          l = amount / 2;
        }
      }

      return {
        id: String(it.id || uid()),
        name: String(it.name || "Posten"),
        amount,
        payer,
        moritz_share: m,
        linda_share: l
      };
    }

    function themeTotal(theme){
      return (theme.items || []).reduce((sum, it) => sum + (Number(it.amount) || 0), 0);
    }
    function totalOfThemes(themes){
      return (themes || []).reduce((sum,t) => sum + themeTotal(t), 0);
    }

    function personShareOfItem(it, personId){
      const amt = Number(it.amount) || 0;
      const payer = normalizePayer(it.payer);

      if(payer === personId) return amt;
      if(payer === "split_custom"){
        const m = Number(it.moritz_share) || 0;
        const l = Number(it.linda_share) || 0;
        return personId === "moritz" ? m : l;
      }
      return 0;
    }
    function themeTotalForPerson(theme, personId){
      let sum = 0;
      for(const it of (theme.items || [])){
        sum += personShareOfItem(it, personId);
      }
      return sum;
    }
    function totalForPerson(themes, personId){
      return (themes || []).reduce((s,t) => s + themeTotalForPerson(t, personId), 0);
    }

    function randomNiceColor(){
      const palette = ["#f2b277","#c95a7a","#a98bc9","#7ac28b","#6aa7d9","#f0d44a","#f29aa2","#89c2c7","#f08f57"];
      return palette[Math.floor(Math.random() * palette.length)];
    }

    /** Seeds **/
    const SEED_MAIN = {
      themes: [
        mkTheme("Wohnung (warm)", "#f2b277", [{ name:"Wohnung (warm)", amount:1090, payer:"split_custom", moritz_share:545, linda_share:545 }]),
        mkTheme("Rücklage Nachzahlung", "#7ac28b", [{ name:"Rücklage Nachzahlung", amount:75, payer:"split_custom", moritz_share:37.5, linda_share:37.5 }]),
        mkTheme("Lebenserhaltungskosten (essen, etc.)", "#c95a7a", [{ name:"Lebenserhaltungskosten", amount:650, payer:"split_custom", moritz_share:325, linda_share:325 }]),
        mkTheme("Auto Versicherung", "#a98bc9", [{ name:"Auto Versicherung", amount:92.02, payer:"split_custom", moritz_share:46.01, linda_share:46.01 }]),
        mkTheme("Strom (inkl. Nachtspeicher)", "#f0d44a", [{ name:"Strom", amount:310, payer:"split_custom", moritz_share:155, linda_share:155 }]),
        mkTheme("Internet (Vertrag + Router)", "#6aa7d9", [{ name:"Internet", amount:57, payer:"split_custom", moritz_share:28.5, linda_share:28.5 }]),
        mkTheme("Handy (2 Verträge)", "#f29aa2", [{ name:"Handy", amount:90, payer:"split_custom", moritz_share:45, linda_share:45 }]),
        mkTheme("Abonnements (Fitness, Programme, Mitgliedschaften)", "#f08f57", [
          { name:"Microsoft", amount:7.00, payer:"linda" },
          { name:"Microsoft", amount:2.78, payer:"moritz" },
          { name:"Adobe", amount:66.00, payer:"split_custom", moritz_share:33.00, linda_share:33.00 },
          { name:"Amazon Prime", amount:8.99, payer:"linda" },
          { name:"Verdi", amount:27.50, payer:"linda" },
          { name:"Verdi", amount:27.50, payer:"moritz" },
          { name:"SPD Land", amount:7.50, payer:"linda" },
          { name:"SPD Land", amount:7.50, payer:"moritz" },
          { name:"Selection", amount:31.80, payer:"linda" },
          { name:"Selection", amount:31.80, payer:"moritz" },
          { name:"awo", amount:2.50, payer:"linda" },
          { name:"awo", amount:2.50, payer:"moritz" },
          { name:"Spotify", amount:8.78, payer:"split_custom", moritz_share:4.39, linda_share:4.39 }
        ]),
        mkTheme("Versicherungen (Hafti, Recht, Hausrat)", "#89c2c7", [{ name:"Versicherungen", amount:45, payer:"split_custom", moritz_share:15, linda_share:30 }]),
      ]
    };

    /** Storage **/
    function saveMain(){ localStorage.setItem(LS_MAIN, JSON.stringify(mainState)); }
    function loadMain(){
      const tryKeys = ["finance_bubbles_v2", "finance_bubbles_v1"];
      for(const key of tryKeys){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) continue;
          const parsed = JSON.parse(raw);
          if(!parsed || !Array.isArray(parsed.themes)) continue;
          parsed.themes = normalizeThemes(parsed.themes);
          return parsed;
        }catch{}
      }
      return null;
    }
    function normalizeThemes(themes){
      return themes.map(t => ({
        id: String(t.id || uid()),
        name: String(t.name || "Unbenannt"),
        color: String(t.color || "#cccccc"),
        items: Array.isArray(t.items) ? t.items.map(it => {
          let payer = it.payer;
          if(String(payer) === "split") payer = "split_custom";
          return normalizeItem({
            id: String(it.id || uid()),
            name: String(it.name || "Posten"),
            amount: Number(it.amount || 0),
            payer,
            moritz_share: it.moritz_share,
            linda_share: it.linda_share
          });
        }) : []
      }));
    }

    function yyyymmNow(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${d.getFullYear()}-${m}`;
    }

    function saveLiving(){ localStorage.setItem(LS_LIVING, JSON.stringify(livingState)); }
    function loadLiving(){
      try{
        const raw = localStorage.getItem(LS_LIVING);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        if(!parsed || typeof parsed !== "object") return null;
        parsed.currentMonth = String(parsed.currentMonth || yyyymmNow());
        parsed.months = parsed.months && typeof parsed.months === "object" ? parsed.months : {};
        parsed.notes = parsed.notes && typeof parsed.notes === "object" ? parsed.notes : {};
        for(const [k,v] of Object.entries(parsed.months)){
          if(!v || typeof v !== "object") continue;
          v.themes = Array.isArray(v.themes) ? normalizeThemes(v.themes) : [];
        }
        return parsed;
      }catch{ return null; }
    }

    function makeDefaultLivingState(){
      const month = yyyymmNow();
      return { currentMonth: month, months: { [month]: { themes: [] } }, notes: { [month]: [] } };
    }
    function ensureLivingMonth(month){
      if(!livingState.months[month]) livingState.months[month] = { themes: [] };
      if(!livingState.notes[month]) livingState.notes[month] = [];
    }

    /** Bubble layout **/
    function layoutBubbles(themes, rect, totalsOverrideMap=null){
      const padding = 10;
      const placed = [];

      const totals = themes.map(t => (totalsOverrideMap ? (totalsOverrideMap.get(t.id) ?? 0) : themeTotal(t)));
      const maxTotal = Math.max(1, ...totals);
      const minR = 44;
      const maxR = Math.min(rect.w, rect.h) * 0.26;

      const scale = (v) => {
        const norm = Math.sqrt((v || 0) / maxTotal);
        return clamp(minR + norm * (maxR - minR), minR, maxR);
      };

      const items = themes
        .map((t) => ({ id:t.id, r: scale(totalsOverrideMap ? (totalsOverrideMap.get(t.id) ?? 0) : themeTotal(t)) }))
        .sort((a,b) => b.r - a.r);

      const cx = rect.w / 2;
      const cy = rect.h / 2;

      for(const it of items){
        let angle = 0;
        let radius = 0;
        let x = cx, y = cy;

        for(let step=0; step<2400; step++){
          angle += 0.35;
          radius += 0.22;
          x = cx + Math.cos(angle) * radius * 6;
          y = cy + Math.sin(angle) * radius * 6;

          x = clamp(x, padding + it.r, rect.w - padding - it.r);
          y = clamp(y, padding + it.r, rect.h - padding - it.r);

          let ok = true;
          for(const p of placed){
            const dx = x - p.x;
            const dy = y - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < (it.r + p.r + 8)){ ok = false; break; }
          }
          if(ok) break;
        }
        placed.push({ ...it, x, y });
      }

      return placed;
    }

    /** State **/
    let route = "gesamt";
    let activePerson = "moritz";

    let mainState = loadMain() ?? structuredClone(SEED_MAIN);
    let livingState = loadLiving() ?? makeDefaultLivingState();
    let livingMonth = livingState.currentMonth;

    let modalContext = { dataset: "main", themeId: null };

    /** DOM **/
    const app = document.getElementById("app");
    const pageTitle = document.getElementById("pageTitle");
    const pageSubtitle = document.getElementById("pageSubtitle");
    const topRightPill = document.getElementById("topRightPill");

    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => setRoute(btn.dataset.route));
    });

    // Modal DOM
    const backdrop = document.getElementById("backdrop");
    const btnClose = document.getElementById("btnClose");
    const btnDeleteTheme = document.getElementById("btnDeleteTheme");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");

    const themeName = document.getElementById("themeName");
    const themeColor = document.getElementById("themeColor");
    const btnSaveTheme = document.getElementById("btnSaveTheme");

    const itemName = document.getElementById("itemName");
    const itemAmount = document.getElementById("itemAmount");
    const itemPayer = document.getElementById("itemPayer");
    const itemMoritz = document.getElementById("itemMoritz");
    const itemLinda = document.getElementById("itemLinda");
    const btnAddItem = document.getElementById("btnAddItem");

    const itemsTbody = document.getElementById("itemsTbody");
    const themeTotalPill = document.getElementById("themeTotalPill");
    const themeItemsPill = document.getElementById("themeItemsPill");
    const addItemHint = document.getElementById("addItemHint");

    /** Router **/
    function setRoute(next){
      route = next;
      document.querySelectorAll(".tab").forEach(b => b.classList.toggle("active", b.dataset.route === route));
      closeTheme();
      render();
    }

    /** Top right pill **/
    function renderTopRight(){
      if(route === "privat_linda"){
        topRightPill.textContent = "Privat ✍️";
        return;
      }

      if(route === "lebenserhaltung"){
        ensureLivingMonth(livingMonth);
        const themes = livingState.months[livingMonth].themes;
        const spent = totalOfThemes(themes);
        topRightPill.textContent = `Rest: ${euro(LIVING_START - spent)}`;
        return;
      }

      if(route === "pro_person"){
        const total = totalForPerson(mainState.themes, activePerson);
        const name = activePerson === "moritz" ? "Moritz" : "Linda";
        topRightPill.textContent = `${name}: ${euro(total)}`;
        return;
      }

      const total = totalOfThemes(mainState.themes);
      topRightPill.textContent = `Gesamt: ${euro(total)}`;
    }

    /** Render **/
    function render(){
      renderTopRight();

      if(route === "privat_linda"){
        pageTitle.textContent = "PRIVAT (LINDA)";
        pageSubtitle.textContent = "Nur für deine persönliche Übersicht. Komplett getrennt – keine Auswirkung auf Fixkosten oder Lebenserhaltung.";
        renderPrivateLindaView();
        return;
      }

      if(route === "gesamt"){
        pageTitle.textContent = "FIXKOSTEN ÜBERSICHT";
        pageSubtitle.textContent = "Gesamtansicht. Klick auf Bubble → Details. Summe oben aktualisiert sich automatisch.";
        renderBubblesView({
          dataset: "main",
          themes: mainState.themes,
          headerLeftLabel: "Gesamt (Monat)",
          headerLeftValue: euro(totalOfThemes(mainState.themes)),
          extraControls: (container) => {
            const row = document.createElement("div");
            row.className = "row";
            row.innerHTML = `
              <button class="primary" id="btnAddTheme">+ Thema</button>
              <button class="danger" id="btnResetMain">Reset Fixkosten</button>
            `;
            container.appendChild(row);

            row.querySelector("#btnAddTheme").addEventListener("click", () => {
              const name = prompt("Name für neues Thema:", "Neues Thema");
              if(name === null) return;
              const t = mkTheme(name.trim() || "Neues Thema", randomNiceColor(), []);
              mainState.themes.push(t);
              saveMain();
              render();
              openTheme("main", t.id);
            });

            row.querySelector("#btnResetMain").addEventListener("click", () => {
              const ok = confirm("Fixkosten auf Seed zurücksetzen?");
              if(!ok) return;
              mainState = structuredClone(SEED_MAIN);
              saveMain();
              render();
            });
          }
        });
        return;
      }

      if(route === "pro_person"){
        pageTitle.textContent = "PRO PERSON";
        pageSubtitle.textContent = "Wähle Moritz oder Linda. „Geteilt (individuell)“ lässt unterschiedliche Anteile pro Posten zu.";
        renderProPersonSingleView();
        return;
      }

      if(route === "lebenserhaltung"){
        pageTitle.textContent = "LEBENSERHALTUNG";
        pageSubtitle.textContent = "Eigenes Bubble-Diagramm pro Monat. Oben rechts: Rest (Start 650 € minus Diagramm-Summe).";
        ensureLivingMonth(livingMonth);
        saveLiving();
        renderLivingView();
        return;
      }
    }

    /** Shared bubbles view **/
    function renderBubblesView({ dataset, themes, headerLeftLabel, headerLeftValue, totalsOverrideMap=null, extraControls=null, mountEl=null }){
      const root = mountEl || app;
      root.innerHTML = "";

      const statsPanel = document.createElement("section");
      statsPanel.className = "panel stats";
      statsPanel.innerHTML = `
        <div class="stat">
          <div class="label">${escapeHTML(headerLeftLabel)}</div>
          <div class="value">${escapeHTML(headerLeftValue)}</div>
        </div>
        <div class="stat">
          <div class="label">Themen</div>
          <div class="value">${themes.length}</div>
        </div>
        <div class="stat">
          <div class="label">Speicher</div>
          <div class="value" style="font-size:14px;">LocalStorage ✅</div>
          <div class="tiny">Fixkosten: <code>${LS_MAIN}</code></div>
        </div>
      `;
      root.appendChild(statsPanel);

      const controlsPanel = document.createElement("section");
      controlsPanel.className = "panel";
      if(extraControls) extraControls(controlsPanel);
      root.appendChild(controlsPanel);

      const stagePanel = document.createElement("section");
      stagePanel.className = "panel";
      stagePanel.innerHTML = `
        <div class="stage" id="stage"></div>
        <p class="tiny" style="margin:10px 2px 0;">Tip: Bei Overlap Browser kurz resize → neu layouten.</p>
      `;
      root.appendChild(stagePanel);

      const stage = stagePanel.querySelector("#stage");

      const doStageRender = () => {
        stage.innerHTML = "";
        const rect = stage.getBoundingClientRect();
        const placements = layoutBubbles(themes, { w: rect.width, h: rect.height }, totalsOverrideMap);

        for(const p of placements){
          const theme = themes.find(t => t.id === p.id);
          if(!theme) continue;

          const shownTotal = totalsOverrideMap ? (totalsOverrideMap.get(theme.id) ?? 0) : themeTotal(theme);

          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.style.width = (p.r * 2) + "px";
          bubble.style.height = (p.r * 2) + "px";
          bubble.style.left = (p.x - p.r) + "px";
          bubble.style.top = (p.y - p.r) + "px";
          bubble.style.background = theme.color;

          const nameSize = clamp(Math.round(p.r * 0.18), 12, 30);
          const amountSize = clamp(Math.round(p.r * 0.28), 14, 54);

          bubble.innerHTML = `
            <div>
              <div class="name" style="font-size:${nameSize}px">${escapeHTML(theme.name)}</div>
              <div class="amount" style="font-size:${amountSize}px">${escapeHTML(euro(shownTotal))}</div>
              <div class="meta">${theme.items.length} Posten</div>
            </div>
          `;
          bubble.addEventListener("click", () => openTheme(dataset, theme.id));
          stage.appendChild(bubble);
        }
      };

      doStageRender();
      let timer = null;
      window.addEventListener("resize", () => {
        clearTimeout(timer);
        timer = setTimeout(doStageRender, 80);
      }, { passive:true });
    }

    /** Pro person **/
    function renderProPersonSingleView(){
      app.innerHTML = "";
      const themes = mainState.themes;

      const moritzTotal = totalForPerson(themes, "moritz");
      const lindaTotal = totalForPerson(themes, "linda");
      const combined = totalOfThemes(themes);
      const selectedTotal = totalForPerson(themes, activePerson);

      const controls = document.createElement("section");
      controls.className = "panel";
      controls.innerHTML = `
        <div class="row" style="align-items:center;">
          <div class="seg" aria-label="Person auswählen">
            <button id="segMoritz" class="${activePerson==="moritz" ? "active":""}">Moritz</button>
            <button id="segLinda" class="${activePerson==="linda" ? "active":""}">Linda</button>
          </div>
          <div class="pill">Ausgewählt: ${activePerson==="moritz" ? "Moritz" : "Linda"} • ${escapeHTML(euro(selectedTotal))}</div>
          <div class="tiny">Kontrolle: Moritz ${escapeHTML(euro(moritzTotal))} • Linda ${escapeHTML(euro(lindaTotal))} • Gesamt ${escapeHTML(euro(combined))}</div>
        </div>
      `;
      app.appendChild(controls);

      controls.querySelector("#segMoritz").addEventListener("click", () => {
        activePerson = "moritz";
        render();
      });
      controls.querySelector("#segLinda").addEventListener("click", () => {
        activePerson = "linda";
        render();
      });

      const bubblesMount = document.createElement("section");
      bubblesMount.className = "panel";
      bubblesMount.style.padding = "0";
      bubblesMount.style.background = "transparent";
      bubblesMount.style.border = "0";
      bubblesMount.style.boxShadow = "none";
      app.appendChild(bubblesMount);

      const map = new Map();
      for(const t of themes){
        map.set(t.id, themeTotalForPerson(t, activePerson));
      }

      renderBubblesView({
        dataset: "main",
        themes,
        totalsOverrideMap: map,
        headerLeftLabel: `${activePerson==="moritz" ? "Moritz" : "Linda"} (Monat)`,
        headerLeftValue: euro(selectedTotal),
        extraControls: (container) => {
          const hint = document.createElement("div");
          hint.className = "tiny";
          hint.textContent = "Klick auf Bubble öffnet globale Details. Dort stellst du pro Posten die Anteile ein.";
          container.appendChild(hint);
        },
        mountEl: bubblesMount
      });
    }

    /** Living view **/
    function renderLivingView(){
      app.innerHTML = "";

      const themes = livingState.months[livingMonth].themes;
      const spent = totalOfThemes(themes);
      const remaining = LIVING_START - spent;

      const statsPanel = document.createElement("section");
      statsPanel.className = "panel stats";
      statsPanel.innerHTML = `
        <div class="stat">
          <div class="label">Monat</div>
          <div class="value">${escapeHTML(livingMonth)}</div>
        </div>
        <div class="stat">
          <div class="label">Ausgegeben (Diagramm)</div>
          <div class="value">${escapeHTML(euro(spent))}</div>
        </div>
        <div class="stat">
          <div class="label">Rest (Start ${escapeHTML(euro(LIVING_START))})</div>
          <div class="value">${escapeHTML(euro(remaining))}</div>
        </div>
      `;
      app.appendChild(statsPanel);

      const controlsPanel = document.createElement("section");
      controlsPanel.className = "panel";
      controlsPanel.innerHTML = `
        <div class="row">
          <div>
            <label>Monat auswählen</label>
            <input id="monthPicker" type="month" value="${escapeHTML(livingMonth)}">
          </div>
          <div class="shrink">
            <label>&nbsp;</label>
            <button class="primary" id="btnCreateMonth">Monat anlegen</button>
          </div>
          <div class="shrink">
            <label>&nbsp;</label>
            <button class="primary" id="btnAddLivingTheme">+ Bubble</button>
          </div>
          <div class="shrink">
            <label>&nbsp;</label>
            <button class="danger" id="btnResetLivingDiagram">Reset Diagramm</button>
          </div>
        </div>
        <div class="tiny" style="margin-top:8px;">
          Reset betrifft nur das Diagramm im gewählten Monat – die Notiz-Tabelle bleibt erhalten.
        </div>
      `;
      app.appendChild(controlsPanel);

      controlsPanel.querySelector("#monthPicker").addEventListener("change", (e) => {
        livingMonth = String(e.target.value || yyyymmNow());
        livingState.currentMonth = livingMonth;
        ensureLivingMonth(livingMonth);
        saveLiving();
        render();
      });

      controlsPanel.querySelector("#btnCreateMonth").addEventListener("click", () => {
        const val = String(controlsPanel.querySelector("#monthPicker").value || yyyymmNow());
        ensureLivingMonth(val);
        livingMonth = val;
        livingState.currentMonth = val;
        saveLiving();
        render();
      });

      controlsPanel.querySelector("#btnAddLivingTheme").addEventListener("click", () => {
        const name = prompt("Name für neue Bubble (Lebenserhaltung):", "Neuer Bereich");
        if(name === null) return;
        const t = mkTheme(name.trim() || "Neuer Bereich", randomNiceColor(), []);
        livingState.months[livingMonth].themes.push(t);
        saveLiving();
        render();
        openTheme("living", t.id);
      });

      controlsPanel.querySelector("#btnResetLivingDiagram").addEventListener("click", () => {
        const ok = confirm(`Diagramm für ${livingMonth} wirklich zurücksetzen? (Notizen bleiben)`);
        if(!ok) return;
        livingState.months[livingMonth].themes = [];
        saveLiving();
        render();
      });

      const stagePanel = document.createElement("section");
      stagePanel.className = "panel";
      stagePanel.innerHTML = `
        <div class="stage" id="livingStage"></div>
        <p class="tiny" style="margin:10px 2px 0;">Klick auf Bubble → Details. Werte wirken direkt auf den Monats-Rest.</p>
      `;
      app.appendChild(stagePanel);

      const stage = stagePanel.querySelector("#livingStage");
      const doStageRender = () => {
        stage.innerHTML = "";
        const rect = stage.getBoundingClientRect();
        const placements = layoutBubbles(themes, { w: rect.width, h: rect.height });

        for(const p of placements){
          const theme = themes.find(t => t.id === p.id);
          if(!theme) continue;

          const total = themeTotal(theme);

          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.style.width = (p.r * 2) + "px";
          bubble.style.height = (p.r * 2) + "px";
          bubble.style.left = (p.x - p.r) + "px";
          bubble.style.top = (p.y - p.r) + "px";
          bubble.style.background = theme.color;

          const nameSize = clamp(Math.round(p.r * 0.18), 12, 30);
          const amountSize = clamp(Math.round(p.r * 0.28), 14, 54);

          bubble.innerHTML = `
            <div>
              <div class="name" style="font-size:${nameSize}px">${escapeHTML(theme.name)}</div>
              <div class="amount" style="font-size:${amountSize}px">${escapeHTML(euro(total))}</div>
              <div class="meta">${theme.items.length} Posten</div>
            </div>
          `;
          bubble.addEventListener("click", () => openTheme("living", theme.id));
          stage.appendChild(bubble);
        }
      };
      doStageRender();

      // Notes
      const notesPanel = document.createElement("section");
      notesPanel.className = "panel";
      notesPanel.innerHTML = `
        <h3 style="margin:0 0 10px;">Notizen – Übrig geblieben (wirkt auf nichts)</h3>

        <div class="row" style="margin-bottom:10px;">
          <div>
            <label>Datum (optional)</label>
            <input id="noteDate" type="text" placeholder="z.B. 31.01.2026">
          </div>
          <div>
            <label>Übrig geblieben (€)</label>
            <input id="noteLeftover" type="number" step="0.01" placeholder="z.B. 120">
          </div>
          <div class="shrink">
            <label>&nbsp;</label>
            <button class="primary" id="btnAddNote">+ Eintragen</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th class="right">Übrig (€)</th>
              <th class="right">Aktion</th>
            </tr>
          </thead>
          <tbody id="notesTbody"></tbody>
        </table>
        <p class="tiny" style="margin-top:10px;">Diese Tabelle ist nur eine Notiz – kein Einfluss auf Diagramm/Summen.</p>
      `;
      app.appendChild(notesPanel);

      const notesTbody = notesPanel.querySelector("#notesTbody");

      function renderNotes(){
        const rows = livingState.notes[livingMonth] || [];
        notesTbody.innerHTML = "";
        if(rows.length === 0){
          notesTbody.innerHTML = `<tr><td colspan="3" class="muted">Noch keine Einträge.</td></tr>`;
          return;
        }
        for(const r of rows){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHTML(r.date || "")}</td>
            <td class="right">${escapeHTML(String(Number(r.leftover || 0).toFixed(2)))}</td>
            <td class="right"><button class="danger" data-id="${escapeHTML(r.id)}">Löschen</button></td>
          `;
          tr.querySelector("button").addEventListener("click", () => {
            livingState.notes[livingMonth] = (livingState.notes[livingMonth] || []).filter(x => x.id !== r.id);
            saveLiving();
            renderNotes();
          });
          notesTbody.appendChild(tr);
        }
      }

      notesPanel.querySelector("#btnAddNote").addEventListener("click", () => {
        const date = notesPanel.querySelector("#noteDate").value.trim();
        const leftover = Number(notesPanel.querySelector("#noteLeftover").value || 0);
        livingState.notes[livingMonth] = livingState.notes[livingMonth] || [];
        livingState.notes[livingMonth].push({ id: uid(), date, leftover });
        saveLiving();
        notesPanel.querySelector("#noteDate").value = "";
        notesPanel.querySelector("#noteLeftover").value = "";
        renderNotes();
      });

      renderNotes();

      let timer = null;
      window.addEventListener("resize", () => {
        clearTimeout(timer);
        timer = setTimeout(doStageRender, 80);
      }, { passive:true });
    }

    /** PRIVATE LINDA VIEW (Top-Level!) **/
    function renderPrivateLindaView(){
      app.innerHTML = "";

      const info = document.createElement("section");
      info.className = "panel";
      info.innerHTML = `
        <div class="tiny">
          Diese Seite ist <b>nur für dich</b> und wird lokal im Browser gespeichert (<code>${LS_PRIVATE_LINDA}</code>).
          Kein Einfluss auf andere Bereiche.
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="primary" id="btnAddPrivateBlock">+ Bereich</button>
          <button class="danger" id="btnResetPrivate">Reset Privat</button>
        </div>
      `;
      app.appendChild(info);

      const list = document.createElement("section");
      list.className = "panel";
      app.appendChild(list);

      function draw(){
        list.innerHTML = "";

        const blocks = privateLindaState.blocks || [];
        if(blocks.length === 0){
          list.innerHTML = `<div class="muted" style="font-size:13px;">Noch keine Einträge.</div>`;
          return;
        }

        for(const b of blocks){
          const card = document.createElement("div");
          card.className = "panel";
          card.style.background = "#fff";
          card.style.marginBottom = "12px";

          card.innerHTML = `
            <div class="row" style="align-items:flex-end;">
              <div>
                <label>Titel</label>
                <input data-role="ptitle" data-id="${escapeHTML(b.id)}" type="text" value="${escapeHTML(b.title)}" />
              </div>
              <div class="shrink">
                <button class="danger" data-role="pdel" data-id="${escapeHTML(b.id)}">Löschen</button>
              </div>
            </div>

            <div style="margin-top:10px;">
              <label>Inhalt</label>
              <textarea data-role="pcontent" data-id="${escapeHTML(b.id)}">${escapeHTML(b.content)}</textarea>
              <div class="tiny" style="margin-top:6px;">Tipp: Du kannst hier alles reinschreiben – frei formatiert als Text.</div>
            </div>
          `;
          list.appendChild(card);
        }

        list.querySelectorAll('input[data-role="ptitle"]').forEach(inp => {
          inp.addEventListener("input", () => {
            const blk = (privateLindaState.blocks || []).find(x => x.id === inp.dataset.id);
            if(!blk) return;
            blk.title = inp.value;
            savePrivateLinda();
          });
        });

        list.querySelectorAll('textarea[data-role="pcontent"]').forEach(ta => {
          ta.addEventListener("input", () => {
            const blk = (privateLindaState.blocks || []).find(x => x.id === ta.dataset.id);
            if(!blk) return;
            blk.content = ta.value;
            savePrivateLinda();
          });
        });

        list.querySelectorAll('button[data-role="pdel"]').forEach(btn => {
          btn.addEventListener("click", () => {
            privateLindaState.blocks = (privateLindaState.blocks || []).filter(x => x.id !== btn.dataset.id);
            savePrivateLinda();
            draw();
          });
        });
      }

      info.querySelector("#btnAddPrivateBlock").addEventListener("click", () => {
        privateLindaState.blocks = privateLindaState.blocks || [];
        privateLindaState.blocks.unshift({ id: uid(), title: "Neuer Bereich", content: "" });
        savePrivateLinda();
        draw();
      });

      info.querySelector("#btnResetPrivate").addEventListener("click", () => {
        const ok = confirm("Privat-Bereich wirklich zurücksetzen?");
        if(!ok) return;
        privateLindaState = structuredClone(SEED_PRIVATE_LINDA);
        savePrivateLinda();
        draw();
      });

      draw();
    }

    /** Modal open/close **/
    function openTheme(dataset, themeId){
      modalContext = { dataset, themeId };
      const theme = getThemeByContext();
      if(!theme) return;

      modalTitle.textContent = theme.name;
      modalSub.textContent =
        dataset === "living"
          ? `Lebenserhaltung • Monat ${livingMonth} • ID: ${theme.id}`
          : `Fixkosten • ID: ${theme.id}`;

      themeName.value = theme.name;
      themeColor.value = theme.color;

      itemName.value = "";
      itemAmount.value = "";
      itemPayer.value = "split_custom";
      itemMoritz.value = "";
      itemLinda.value = "";
      updateAddItemHint();

      btnDeleteTheme.textContent = (dataset === "living") ? "Bubble löschen" : "Thema löschen";

      renderThemeItems();
      backdrop.style.display = "flex";
    }

    function closeTheme(){
      modalContext = { dataset: "main", themeId: null };
      backdrop.style.display = "none";
    }

    function getThemeByContext(){
      const { dataset, themeId } = modalContext;
      if(!themeId) return null;
      if(dataset === "living"){
        const themes = livingState.months[livingMonth].themes;
        return themes.find(t => t.id === themeId) || null;
      }
      return mainState.themes.find(t => t.id === themeId) || null;
    }

    function deleteThemeByContext(){
      const { dataset, themeId } = modalContext;
      if(!themeId) return;

      if(dataset === "living"){
        const themes = livingState.months[livingMonth].themes;
        livingState.months[livingMonth].themes = themes.filter(t => t.id !== themeId);
        saveLiving();
      }else{
        mainState.themes = mainState.themes.filter(t => t.id !== themeId);
        saveMain();
      }

      closeTheme();
      render();
    }

    btnClose.addEventListener("click", closeTheme);
    backdrop.addEventListener("click", (e) => { if(e.target === backdrop) closeTheme(); });
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && backdrop.style.display === "flex") closeTheme();
    });

    btnDeleteTheme.addEventListener("click", () => {
      const theme = getThemeByContext();
      if(!theme) return;
      const label = (modalContext.dataset === "living") ? "Bubble" : "Thema";
      const ok = confirm(`${label} wirklich löschen?\n\n${theme.name}`);
      if(!ok) return;
      deleteThemeByContext();
    });

    btnSaveTheme.addEventListener("click", () => {
      const theme = getThemeByContext();
      if(!theme) return;

      theme.name = themeName.value.trim() || "Unbenannt";
      theme.color = themeColor.value || theme.color;

      persist();
      modalTitle.textContent = theme.name;
      renderThemeItems();
      render();
    });

    itemPayer.addEventListener("change", updateAddItemHint);
    function updateAddItemHint(){
      const p = normalizePayer(itemPayer.value);
      if(p === "split_custom"){
        addItemHint.innerHTML = `Tipp: Bei <b>Geteilt (individuell)</b> sollten <b>Moritz+Linda = Betrag</b> sein.`;
        itemMoritz.disabled = false;
        itemLinda.disabled = false;
      }else{
        addItemHint.innerHTML = `Hinweis: Bei <b>${p === "moritz" ? "Moritz" : "Linda"}</b> zahlt die Person den vollen Betrag.`;
        itemMoritz.disabled = true;
        itemLinda.disabled = true;
      }
    }

    btnAddItem.addEventListener("click", () => {
      const theme = getThemeByContext();
      if(!theme) return;

      const name = itemName.value.trim() || "Neuer Posten";
      const amount = Number(itemAmount.value || 0);
      const payer = normalizePayer(itemPayer.value);

      let it = { id: uid(), name, amount, payer, moritz_share:0, linda_share:0 };

      if(payer === "split_custom"){
        const m = Number(itemMoritz.value || 0);
        const l = Number(itemLinda.value || 0);
        it.moritz_share = m;
        it.linda_share = l;

        const diff = Math.abs((m + l) - amount);
        if(diff > 0.01){
          alert("Hinweis: Moritz+Linda ist nicht gleich dem Betrag. Das ist erlaubt, aber dann stimmt die Personensumme nicht 1:1 zum Gesamtbetrag.");
        }
      }

      theme.items.push(normalizeItem(it));

      itemName.value = "";
      itemAmount.value = "";
      itemPayer.value = "split_custom";
      itemMoritz.value = "";
      itemLinda.value = "";
      updateAddItemHint();

      persist();
      renderThemeItems();
      render();
    });

    function persist(){
      if(modalContext.dataset === "living") saveLiving();
      else saveMain();
    }

    function renderThemeItems(){
      const theme = getThemeByContext();
      if(!theme) return;

      const total = themeTotal(theme);
      themeTotalPill.textContent = `Summe: ${euro(total)}`;
      themeItemsPill.textContent = `Posten: ${theme.items.length}`;

      itemsTbody.innerHTML = "";
      if(theme.items.length === 0){
        itemsTbody.innerHTML = `<tr><td colspan="6" class="muted">Noch keine Posten.</td></tr>`;
        return;
      }

      for(const itRaw of theme.items){
        const it = normalizeItem(itRaw);
        Object.assign(itRaw, it);

        const p = normalizePayer(it.payer);
        const mShare = (p === "split_custom") ? (Number(it.moritz_share)||0) : (p === "moritz" ? Number(it.amount)||0 : 0);
        const lShare = (p === "split_custom") ? (Number(it.linda_share)||0) : (p === "linda" ? Number(it.amount)||0 : 0);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <input data-role="name" data-id="${escapeHTML(it.id)}" type="text" value="${escapeHTML(it.name)}"
              style="width:100%; border:1px solid var(--border); border-radius:10px; padding:8px 10px;">
          </td>
          <td class="right">
            <input data-role="amount" data-id="${escapeHTML(it.id)}" type="number" step="0.01" value="${Number(it.amount || 0)}"
              style="width:140px; text-align:right; border:1px solid var(--border); border-radius:10px; padding:8px 10px;">
          </td>
          <td>
            <select data-role="payer" data-id="${escapeHTML(it.id)}"
              style="border:1px solid var(--border); border-radius:10px; padding:8px 10px;">
              <option value="moritz" ${p==="moritz" ? "selected":""}>Moritz</option>
              <option value="linda" ${p==="linda" ? "selected":""}>Linda</option>
              <option value="split_custom" ${p==="split_custom" ? "selected":""}>Geteilt (individuell)</option>
            </select>
          </td>
          <td class="right">
            <input data-role="moritz_share" data-id="${escapeHTML(it.id)}" type="number" step="0.01" value="${mShare}"
              style="width:120px; text-align:right; border:1px solid var(--border); border-radius:10px; padding:8px 10px;"
              ${p==="split_custom" ? "" : "disabled"}>
          </td>
          <td class="right">
            <input data-role="linda_share" data-id="${escapeHTML(it.id)}" type="number" step="0.01" value="${lShare}"
              style="width:120px; text-align:right; border:1px solid var(--border); border-radius:10px; padding:8px 10px;"
              ${p==="split_custom" ? "" : "disabled"}>
          </td>
          <td class="right">
            <button class="danger" data-role="delete" data-id="${escapeHTML(it.id)}">Löschen</button>
          </td>
        `;
        itemsTbody.appendChild(tr);
      }

      itemsTbody.querySelectorAll('input[data-role="name"]').forEach(inp => {
        inp.addEventListener("change", () => {
          const theme = getThemeByContext(); if(!theme) return;
          const item = theme.items.find(x => x.id === inp.dataset.id); if(!item) return;
          item.name = inp.value.trim() || "Posten";
          persist(); renderThemeItems(); render();
        });
      });

      itemsTbody.querySelectorAll('input[data-role="amount"]').forEach(inp => {
        inp.addEventListener("change", () => {
          const theme = getThemeByContext(); if(!theme) return;
          const item = theme.items.find(x => x.id === inp.dataset.id); if(!item) return;
          item.amount = Number(inp.value || 0);
          Object.assign(item, normalizeItem(item));
          persist(); renderThemeItems(); render();
        });
      });

      itemsTbody.querySelectorAll('select[data-role="payer"]').forEach(sel => {
        sel.addEventListener("change", () => {
          const theme = getThemeByContext(); if(!theme) return;
          const item = theme.items.find(x => x.id === sel.dataset.id); if(!item) return;
          item.payer = normalizePayer(sel.value);
          Object.assign(item, normalizeItem(item));
          persist(); renderThemeItems(); render();
        });
      });

      itemsTbody.querySelectorAll('input[data-role="moritz_share"]').forEach(inp => {
        inp.addEventListener("change", () => {
          const theme = getThemeByContext(); if(!theme) return;
          const item = theme.items.find(x => x.id === inp.dataset.id); if(!item) return;
          if(normalizePayer(item.payer) !== "split_custom") return;
          item.moritz_share = Number(inp.value || 0);
          persist(); renderThemeItems(); render();
        });
      });

      itemsTbody.querySelectorAll('input[data-role="linda_share"]').forEach(inp => {
        inp.addEventListener("change", () => {
          const theme = getThemeByContext(); if(!theme) return;
          const item = theme.items.find(x => x.id === inp.dataset.id); if(!item) return;
          if(normalizePayer(item.payer) !== "split_custom") return;
          item.linda_share = Number(inp.value || 0);
          persist(); renderThemeItems(); render();
        });
      });

      itemsTbody.querySelectorAll('button[data-role="delete"]').forEach(btn => {
        btn.addEventListener("click", () => {
          const theme = getThemeByContext(); if(!theme) return;
          theme.items = theme.items.filter(x => x.id !== btn.dataset.id);
          persist(); renderThemeItems(); render();
        });
      });
    }

    /** init **/
    saveMain();
    savePrivateLinda();
    saveLiving();
    updateAddItemHint();
    render();
  </script>
</body>
</html>
